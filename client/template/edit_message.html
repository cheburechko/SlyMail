{% extends "interface.html" %}

{% block mail-content %}
    <form class="row" method="POST" action="{% url processSingle msg_pk %}">
        {% csrf_token %}
        <div class="form-row">
        {{ form.as_p }}
        </div>
        <div class="btn-group form-row">
        <input type="hidden" name="msg_part_pk" value="{{ msg_part_pk }}"/>
        <input type="submit" value="Save" name="save" class="btn btn-default"/>
        <input type="submit" value="Send" name="send" class="btn btn-default"/>
        </div>
    </form>

    <div id='result'>
    {%  for attachment in attachments  %}
        <div class="form-row">
        <a href="{{ attachment.url }}">{{ attachment.name }}</a> - {{ attachment.size }}
        </div>
    {% endfor %}
    </div>

    <form id="fileForm" action="{% url processSingle msg_pk %}" method="POST">
        {% csrf_token %}
    	<input type="file" name="file"/>
    	<input id="form_submit_button" class="tp-button" type="submit" value="Submit" name="upload"/>
	</form>
{% endblock %}

{% block scripts %}
    <script src="{{ STATIC_URL }}jquery.form.min.js"></script>
    <script>
        /**
         * setup JQuery's AJAX methods to setup CSRF token in the request before sending it off.
         * http://stackoverflow.com/questions/5100539/django-csrf-check-failing-with-an-ajax-post-request
         */

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
// Does this cookie string begin with the name we want?

                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
// Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                }
            }
        });

        // wait for the DOM to be loaded
        $(document).ready(function() {
             var options = {
                beforeSubmit:  showRequest,
                uploadProgress:showProgress,
                clearForm:     true,
                success:       showResponse,
                error:         showError
             }
            $('#fileForm').ajaxForm(options);
        });

        var uploadReady = true;

        function showRequest(arr, $form, options)
        {
            if (uploadReady)
            {
                $('#result').append('<div id="pending" class="form-row">Loading...</div>')
                uploadReady = false;
                return true;
            }
            else
                return false;
        }

        function showProgress(event, position, total, percent)
        {
            $('#pending').text('Loading: ' + String(percent) + '%');
        }

        function showError()
        {
            uploadReady = true;
            $('#pending').html("Failed.").removeAttr('id');
        }

        function showResponse(responseText, statusText, xhr, $form)  {
            $('#pending').html(responseText).removeAttr('id');
            uploadReady = true;
        }
    </script>
{% endblock %}